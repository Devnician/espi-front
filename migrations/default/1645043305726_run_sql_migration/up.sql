CREATE OR REPLACE FUNCTION distribute_the_undistributed_users_new(lim int) RETURNS setof counters AS $function$DECLARE    r users;    a_count integer;    response counters;BEGIN    a_count := 0;     FOR r IN        SELECT * FROM users u WHERE u."votingSectionId" IS NULL LIMIT lim    LOOP        UPDATE users SET "votingSectionId" = (            SELECT vs.id from voting_section vs            JOIN addresses a ON a.id = vs."addressId"            WHERE a."settlementId" =            (SELECT a."settlementId" FROM addresses a WHERE a.id =           (SELECT u."addressId" FROM users u WHERE u.id = r."id")))            WHERE id =  r."id";            a_count := a_count + 1;     END LOOP;    raise notice 'counter: %', a_count;    INSERT INTO counters(counter) VALUES (a_count);     RETURN QUERY     select * from counters c where c.counter = a_count limit 1;  END; $function$ LANGUAGE plpgsql;
